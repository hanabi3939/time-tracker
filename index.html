<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ™‚é–“è¿½è¹¤å™¨</title>
<link rel="icon" type="image/x-icon" href="favicon.ico">
<link rel="icon" type="image/x-icon" href="favicon.ico">
<link rel="icon" type="image/png" href="icon.png">
<link rel="icon" type="image/png" href="icon.png">
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0d0d0d;
    --surface: #161616;
    --surface2: #1e1e1e;
    --border: #2a2a2a;
    --accent: #c8f040;
    --accent2: #40f0b4;
    --accent3: #f04080;
    --accent4: #40a0f0;
    --accent5: #f0a040;
    --text: #e8e8e8;
    --muted: #666;
  }
  /* è®“ swatch å®¹å™¨å¯ä»¥å®šä½å‰å‰ */
  .swatch-wrapper {
    position: relative;
    display: inline-block;
  }

  /* åˆªé™¤å°å‰å‰çš„æ¨£å¼ */
  .btn-del-color {
    position: absolute;
    top: -5px;
    right: -5px;
    width: 14px;
    height: 14px;
    background: var(--accent3); /* å…¨æ¸…çš„é¡è‰² */
    color: white;
    border-radius: 50%;
    font-size: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    border: none;
    line-height: 1;
    opacity: 0.8;
  }

.btn-del-color:hover { opacity: 1; transform: scale(1.1); }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Noto Sans TC', sans-serif;
    min-height: 100vh;
    display: grid;
    grid-template-columns: 320px 1fr;
    grid-template-rows: auto 1fr auto;
  }

  header {
    grid-column: 1 / -1;
    padding: 24px 32px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  header h1 {
    font-family: 'Space Mono', monospace;
    font-size: 18px;
    letter-spacing: 0.1em;
    color: var(--accent);
  }

  .header-right {
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .sync-status {
    font-size: 11px;
    font-family: 'Space Mono', monospace;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .sync-dot {
    width: 7px;
    height: 7px;
    border-radius: 50%;
    background: var(--muted);
    transition: background 0.3s;
  }

  .sync-dot.connected { background: var(--accent2); }
  .sync-dot.syncing { background: var(--accent5); animation: blink 0.8s infinite; }
  .sync-dot.error { background: var(--accent3); }

  @keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }

  #live-clock {
    font-size: 12px;
    color: var(--muted);
    font-family: 'Space Mono', monospace;
  }

  .sidebar {
    border-right: 1px solid var(--border);
    padding: 24px;
    display: flex;
    flex-direction: column;
    gap: 16px;
    overflow-y: auto;
  }

  .section-title {
    font-size: 11px;
    letter-spacing: 0.15em;
    color: var(--muted);
    text-transform: uppercase;
    margin-bottom: 4px;
  }

  .timer-display {
    padding: 32px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }

  .timer-face {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 48px;
    text-align: center;
    width: 100%;
    max-width: 500px;
  }

  .current-label {
    font-size: 12px;
    color: var(--muted);
    letter-spacing: 0.1em;
    text-transform: uppercase;
    margin-bottom: 12px;
  }

  .label-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 2px;
    font-size: 12px;
    font-weight: 500;
    margin-bottom: 24px;
  }

  .time-display {
    font-family: 'Space Mono', monospace;
    font-size: clamp(48px, 8vw, 80px);
    font-weight: 700;
    letter-spacing: 0.05em;
    color: var(--accent);
    line-height: 1;
    margin-bottom: 8px;
    transition: color 0.3s;
  }

  .time-display.running { animation: pulse-glow 2s ease-in-out infinite; }

  @keyframes pulse-glow {
    0%, 100% { text-shadow: 0 0 20px rgba(200,240,64,0.3); }
    50% { text-shadow: 0 0 40px rgba(200,240,64,0.6); }
  }

  .session-date {
    font-size: 11px;
    color: var(--muted);
    font-family: 'Space Mono', monospace;
    margin-bottom: 32px;
  }

  .controls {
    display: flex;
    gap: 12px;
    justify-content: center;
    flex-wrap: wrap;
  }

  .btn {
    padding: 12px 28px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--text);
    font-family: 'Space Mono', monospace;
    font-size: 12px;
    letter-spacing: 0.1em;
    cursor: pointer;
    border-radius: 2px;
    transition: all 0.2s;
    text-transform: uppercase;
  }

  .btn:hover { background: var(--surface2); }
  .btn:disabled { opacity: 0.4; cursor: not-allowed; }
  .btn:disabled:hover { background: transparent; }

  .btn-primary { background: var(--accent); color: #000; border-color: var(--accent); font-weight: 700; }
  .btn-primary:hover { background: #d4f550; }
  .btn-danger { border-color: var(--accent3); color: var(--accent3); }
  .btn-danger:hover { background: rgba(240,64,128,0.1); }

  .label-selector {
    margin-top: 24px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    width: 100%;
    max-width: 500px;
  }

  .label-selector-title {
    font-size: 11px;
    color: var(--muted);
    letter-spacing: 0.1em;
    text-transform: uppercase;
  }

  .label-pills { display: flex; flex-wrap: wrap; gap: 8px; }

  .label-pill {
    padding: 6px 14px;
    border-radius: 2px;
    font-size: 12px;
    cursor: pointer;
    border: 1px solid transparent;
    transition: all 0.15s;
    background: var(--surface);
  }

  .label-pill.active { border-color: currentColor; font-weight: 700; }
  .label-pill:hover { opacity: 0.8; }

  .add-label-form { display: flex; gap: 8px; }

  .add-label-form input {
    flex: 1;
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 8px 12px;
    font-family: 'Noto Sans TC', sans-serif;
    font-size: 13px;
    border-radius: 2px;
    outline: none;
  }

  .add-label-form input:focus { border-color: var(--accent); }
  .btn-sm { padding: 8px 14px; font-size: 11px; }

  .session-item {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 2px;
    padding: 10px 12px;
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 12px;
    animation: slide-in 0.2s ease;
  }

  @keyframes slide-in {
    from { opacity: 0; transform: translateY(-4px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .session-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
  .session-info { flex: 1; min-width: 0; }
  .session-label-name { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .session-meta { font-size: 10px; color: var(--muted); font-family: 'Space Mono', monospace; }
  .session-duration { font-family: 'Space Mono', monospace; font-weight: 700; color: var(--accent); white-space: nowrap; }

  .delete-session {
    background: none; border: none; color: var(--muted);
    cursor: pointer; font-size: 14px; padding: 0 2px;
    opacity: 0; transition: opacity 0.2s;
  }

  .session-item:hover .delete-session { opacity: 1; }

  .main-content { display: flex; flex-direction: column; }

  .stats-section { padding: 20px 24px; border-top: 1px solid var(--border); }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 10px;
    margin-top: 12px;
  }

  .stat-card { background: var(--surface); border: 1px solid var(--border); border-radius: 2px; padding: 14px; }
  .stat-label { font-size: 10px; color: var(--muted); letter-spacing: 0.1em; text-transform: uppercase; margin-bottom: 6px; }
  .stat-value { font-family: 'Space Mono', monospace; font-size: 20px; font-weight: 700; }
  .stat-sub { font-size: 10px; color: var(--muted); margin-top: 2px; font-family: 'Space Mono', monospace; }

  .label-stats { margin-top: 12px; display: flex; flex-direction: column; gap: 8px; }

  .label-stat-row { display: flex; align-items: center; gap: 10px; }

  .label-stat-name { font-size: 12px; width: 80px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-shrink: 0; }

  .label-stat-bar-wrap { flex: 1; height: 6px; background: var(--surface2); border-radius: 3px; overflow: hidden; }
  .label-stat-bar { height: 100%; border-radius: 3px; transition: width 0.5s ease; }
  .label-stat-time { font-family: 'Space Mono', monospace; font-size: 11px; color: var(--muted); width: 60px; text-align: right; }

  .view-toggle {
    display: flex; gap: 4px; background: var(--surface);
    border: 1px solid var(--border); border-radius: 3px; padding: 3px;
  }

  .view-btn {
    padding: 4px 10px; font-size: 11px; font-family: 'Space Mono', monospace;
    border: none; background: transparent; color: var(--muted);
    cursor: pointer; border-radius: 2px; letter-spacing: 0.05em; transition: all 0.15s;
  }

  .view-btn.active { background: var(--border); color: var(--text); }

  /* Period toggle */
  .period-toggle {
    display: flex; gap: 3px; background: var(--surface);
    border: 1px solid var(--border); border-radius: 3px; padding: 3px;
  }

  .period-btn {
    padding: 5px 14px; font-size: 11px; font-family: 'Space Mono', monospace;
    border: none; background: transparent; color: var(--muted);
    cursor: pointer; border-radius: 2px; letter-spacing: 0.08em; transition: all 0.15s;
    text-transform: uppercase;
  }

  .period-btn.active {
    background: var(--accent);
    color: #000;
    font-weight: 700;
  }

  .stats-period-header {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 14px;
  }

  .period-range-label {
    font-size: 11px;
    color: var(--muted);
    font-family: 'Space Mono', monospace;
    letter-spacing: 0.05em;
  }

  .pie-wrap { display: flex; align-items: center; gap: 24px; margin-top: 12px; flex-wrap: wrap; }
  .pie-canvas-wrap { position: relative; width: 160px; height: 160px; flex-shrink: 0; }

  .pie-center-text {
    position: absolute; inset: 0;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    pointer-events: none;
  }

  .pie-center-value { font-family: 'Space Mono', monospace; font-size: 16px; font-weight: 700; color: var(--accent); }
  .pie-center-label { font-size: 10px; color: var(--muted); margin-top: 2px; }
  .pie-legend { display: flex; flex-direction: column; gap: 8px; }
  .pie-legend-item { display: flex; align-items: center; gap: 8px; font-size: 12px; }
  .pie-legend-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
  .pie-legend-name { flex: 1; }
  .pie-legend-pct { font-family: 'Space Mono', monospace; font-size: 11px; color: var(--muted); }

  footer {
    grid-column: 1 / -1;
    padding: 12px 32px;
    border-top: 1px solid var(--border);
    font-size: 11px; color: var(--muted);
    font-family: 'Space Mono', monospace;
    display: flex; justify-content: space-between;
  }

  .empty-state { text-align: center; padding: 40px 20px; color: var(--muted); }
  .empty-icon { font-size: 32px; margin-bottom: 8px; }
  .empty-text { font-size: 12px; line-height: 1.6; }

  /* ä¿®æ”¹åŸæœ¬çš„ .color-pickerï¼Œè®“å®ƒå¯ä»¥æ›è¡Œä¸¦èˆ‡ + è™Ÿå°é½Š */
.color-picker { 
  display: flex; 
  gap: 8px; 
  flex-wrap: wrap; /* å…è¨±æ›è¡Œ */
  margin-top: 8px; 
  align-items: center; /* å‚ç›´å±…ä¸­ */
}

/* è‡ªè¨‚é¡è‰²æŒ‰éˆ•æ¨£å¼ */
.btn-add-color {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  border: 1px dashed var(--accent3); /* ä½¿ç”¨ä½ æåˆ°çš„ã€Œå…¨æ¸…ã€å­—é«”é¡è‰² (var(--accent3)) */
  color: var(--accent3);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 16px;
  font-weight: bold;
  background: transparent;
  transition: all 0.2s;
}

.btn-add-color:hover {
  background: rgba(240, 64, 128, 0.1);
}

/* éš±è—åŸç”Ÿé¡è‰²é¸æ“‡å™¨ï¼Œé€éé»æ“Š + è™Ÿè§¸ç™¼ */
#hidden-color-input {
  display: none;
}

  .color-swatch {
    width: 20px; height: 20px; border-radius: 50%;
    cursor: pointer; border: 2px solid transparent; transition: transform 0.15s;
  }

  .color-swatch:hover { transform: scale(1.2); }
  .color-swatch.selected { border-color: white; }

  /* Loading */
  #loading-overlay {
    position: fixed; inset: 0; background: var(--bg);
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    z-index: 999; gap: 16px; transition: opacity 0.5s;
  }

  #loading-overlay.hidden { opacity: 0; pointer-events: none; }

  .loading-logo { font-family: 'Space Mono', monospace; font-size: 20px; color: var(--accent); letter-spacing: 0.2em; }
  .loading-bar-wrap { width: 200px; height: 2px; background: var(--border); border-radius: 1px; overflow: hidden; }
  .loading-bar { height: 100%; background: var(--accent); animation: loading-anim 1.5s ease-in-out infinite; }

  @keyframes loading-anim {
    0% { width: 0%; margin-left: 0; }
    50% { width: 60%; margin-left: 20%; }
    100% { width: 0%; margin-left: 100%; }
  }

  .loading-text { font-size: 11px; color: var(--muted); font-family: 'Space Mono', monospace; letter-spacing: 0.1em; }

  @media (max-width: 700px) {
    body {
      grid-template-columns: 1fr;
      grid-template-rows: auto 1fr auto;
      overflow-x: hidden;
    }

    header {
      padding: 14px 16px;
      grid-column: 1 / -1;
    }

    header h1 { font-size: 14px; }
    #live-clock { display: none; }

    .sync-status { font-size: 10px; }

    /* æ‰‹æ©Ÿç‰ˆæŠŠ sidebar éš±è—ï¼Œæ”¹ç”¨åº•éƒ¨ tab åˆ‡æ› */
    .sidebar { display: none; }

    .main-content {
      grid-column: 1 / -1;
      overflow-x: hidden;
    }

    .timer-display {
      padding: 16px;
      min-height: auto;
    }

    .timer-face {
      padding: 20px 12px;
    }

    .time-display {
      font-size: clamp(36px, 11vw, 56px);
    }

    .controls {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .controls #start-btn {
      grid-column: 1 / -1;
      padding: 16px;
      font-size: 14px;
    }

    .controls #pause-btn,
    .controls #stop-btn {
      padding: 14px;
      font-size: 12px;
    }

    .label-selector { margin-top: 16px; }

    .label-pills { gap: 8px; }

    .label-pill {
      padding: 8px 16px;
      font-size: 13px;
    }

    .stats-section { padding: 16px; }

    .stats-grid {
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .stat-card { padding: 12px; }
    .stat-value { font-size: 18px; }

    .stats-period-header { flex-wrap: wrap; gap: 8px; }

    .period-btn { padding: 5px 12px; font-size: 11px; }

    footer { padding: 10px 16px; font-size: 10px; }

    /* åº•éƒ¨å°è¦½åˆ— */
    .mobile-tabs {
      display: flex;
      position: fixed;
      bottom: 0; left: 0; right: 0;
      background: var(--surface);
      border-top: 1px solid var(--border);
      z-index: 100;
      padding-bottom: env(safe-area-inset-bottom);
    }

    .mobile-tab {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 10px 0;
      font-size: 10px;
      color: var(--muted);
      cursor: pointer;
      transition: color 0.15s;
      font-family: 'Space Mono', monospace;
      letter-spacing: 0.05em;
      gap: 4px;
      background: none;
      border: none;
    }

    .mobile-tab.active { color: var(--accent); }
    .mobile-tab-icon { font-size: 18px; }

    /* æ‰‹æ©Ÿç‰ˆé¢æ¿ */
    .mobile-panel { display: none; }
    .mobile-panel.active { display: block; }

    /* æ‰‹æ©Ÿç‰ˆ sidebar å…§å®¹ç¨ç«‹é¡¯ç¤º */
    .mobile-sidebar-content {
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .mobile-sessions-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-height: 40vh;
      overflow-y: auto;
    }

    /* footer åœ¨æ‰‹æ©Ÿç‰ˆå¾€ä¸Šæ¨ï¼Œé¿å…è¢« tab bar è“‹ä½ */
    footer { margin-bottom: 56px; }

    /* ä¸»å…§å®¹ä¹Ÿéœ€è¦åº•éƒ¨ç©ºé–“ */
    .main-content { padding-bottom: 56px; }
  }

  /* æ¡Œé¢ç‰ˆéš±è—æ‰‹æ©Ÿå…ƒç´  */
  @media (min-width: 701px) {
    .mobile-tabs { display: none; }
    .mobile-panel { display: block !important; }
  }

  /* â”€â”€ å¯†ç¢¼ç•«é¢ â”€â”€ */
  #password-screen {
    position: fixed;
    inset: 0;
    background: var(--bg);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    gap: 24px;
  }

  #password-screen.hidden { display: none; }

  .pw-logo {
    font-family: 'Space Mono', monospace;
    font-size: 20px;
    color: var(--accent);
    letter-spacing: 0.2em;
  }

  .pw-subtitle {
    font-size: 12px;
    color: var(--muted);
    font-family: 'Space Mono', monospace;
    letter-spacing: 0.1em;
  }

  .pw-dots {
    display: flex;
    gap: 14px;
  }

  .pw-dot {
    width: 14px;
    height: 14px;
    border-radius: 50%;
    border: 2px solid var(--border);
    background: transparent;
    transition: all 0.15s;
  }

  .pw-dot.filled {
    background: var(--accent);
    border-color: var(--accent);
  }

  .pw-dot.error {
    background: var(--accent3);
    border-color: var(--accent3);
    animation: shake 0.3s ease;
  }

  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-6px); }
    75% { transform: translateX(6px); }
  }

  .pw-keypad {
    display: grid;
    grid-template-columns: repeat(3, 72px);
    gap: 10px;
  }

  .pw-key {
    height: 72px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    color: var(--text);
    font-family: 'Space Mono', monospace;
    font-size: 20px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.1s;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .pw-key:active { background: var(--border); transform: scale(0.95); }
  .pw-key.zero { grid-column: 2; }
  .pw-key.del { font-size: 16px; color: var(--muted); }
  .pw-error-msg {
    font-size: 12px;
    color: var(--accent3);
    font-family: 'Space Mono', monospace;
    height: 16px;
  }

</style>
</head>
<body>

<div id="password-screen">
  <div class="pw-logo">TIME TRACKER</div>
  <div class="pw-subtitle">è«‹è¼¸å…¥å¯†ç¢¼</div>
  <div class="pw-dots" id="pw-dots">
    <div class="pw-dot"></div>
    <div class="pw-dot"></div>
    <div class="pw-dot"></div>
    <div class="pw-dot"></div>
    <div class="pw-dot"></div>
    <div class="pw-dot"></div>
  </div>
  <div class="pw-error-msg" id="pw-error"></div>
  <div class="pw-keypad">
    <button class="pw-key" data-key="1">1</button>
    <button class="pw-key" data-key="2">2</button>
    <button class="pw-key" data-key="3">3</button>
    <button class="pw-key" data-key="4">4</button>
    <button class="pw-key" data-key="5">5</button>
    <button class="pw-key" data-key="6">6</button>
    <button class="pw-key" data-key="7">7</button>
    <button class="pw-key" data-key="8">8</button>
    <button class="pw-key" data-key="9">9</button>
    <button class="pw-key del" data-key="del">âŒ«</button>
    <button class="pw-key zero" data-key="0">0</button>
  </div>
</div>


<div id="loading-overlay">
  <div class="loading-logo">TIME TRACKER</div>
  <div class="loading-bar-wrap"><div class="loading-bar"></div></div>
  <div class="loading-text" id="loading-text">é€£ç·šè‡³ Firebase...</div>
</div>

<header>
  <h1>TIME TRACKER</h1>
  <div class="header-right">
    <div class="sync-status">
      <div class="sync-dot" id="sync-dot"></div>
      <span id="sync-label">é€£ç·šä¸­</span>
    </div>
    <span id="live-clock"></span>
  </div>
</header>

<aside class="sidebar">
  <div>
    <div class="section-title">æ¨™ç±¤ç®¡ç†</div>
    <div style="margin-top:10px; display:flex; flex-direction:column; gap:8px;" id="labels-manager"></div>
    <div style="margin-top:12px;">
      <div class="add-label-form">
        <input type="text" id="new-label-input" placeholder="æ–°å¢æ¨™ç±¤åç¨±..." maxlength="20">
        <button class="btn btn-sm" id="add-label-btn">ï¼‹</button>
      </div>
      <div class="color-picker">
      <div id="color-picker-list" style="display:flex; flex-wrap:wrap; gap:6px;"></div>
      <button type="button" class="btn-add-color" onclick="document.getElementById('hidden-color-input').click()">+</button>
      <input type="color" id="hidden-color-input" style="display:none;">
    </div>
    </div>
  </div>
  <div style="flex:1; min-height:0; display:flex; flex-direction:column; gap:8px;">
    <div class="section-title" style="display:flex; justify-content:space-between; align-items:center;">
      <span>è¨ˆæ™‚è¨˜éŒ„</span>
      <button class="btn btn-sm btn-danger" id="clear-all-btn" style="padding:3px 8px; font-size:10px;">å…¨æ¸…</button>
    </div>
    <div id="sessions-list" style="flex:1; overflow-y:auto; display:flex; flex-direction:column; gap:6px;"></div>
  </div>
</aside>

<main class="main-content">
  <div class="timer-display">
    <div class="timer-face">
      <div class="current-label">ç›®å‰æ¨™ç±¤</div>
      <div id="active-badge" class="label-badge" style="background:#1e1e1e; color:#666;">å°šæœªé¸æ“‡</div>
      <div class="time-display" id="time-display">00:00:00</div>
      <div class="session-date" id="session-date">â€”</div>
      <div class="controls">
        <button class="btn btn-primary" id="start-btn">â–¶ é–‹å§‹</button>
        <button class="btn" id="pause-btn" disabled>â¸ æš«åœ</button>
        <button class="btn btn-danger" id="stop-btn" disabled>â¹ åœæ­¢</button>
      </div>
    </div>
    <div class="label-selector">
      <div class="label-selector-title">é¸æ“‡æ¨™ç±¤</div>
      <div class="label-pills" id="label-pills"></div>
    </div>
  </div>

  <div class="stats-section">
    <div class="stats-period-header">
      <div>
        <div class="section-title" style="margin-bottom:4px;">çµ±è¨ˆ</div>
        <div class="period-range-label" id="period-range-label">â€”</div>
      </div>
      <div class="period-toggle">
        <button class="period-btn active" id="period-day">æ—¥</button>
        <button class="period-btn" id="period-week">é€±</button>
        <button class="period-btn" id="period-month">æœˆ</button>
      </div>
    </div>
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">ç¸½è¨ˆæ™‚é–“</div>
        <div class="stat-value" id="stat-total" style="color:var(--accent)">0:00</div>
        <div class="stat-sub" id="stat-total-sub">ä»Šæ—¥</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">è¨ˆæ™‚æ¬¡æ•¸</div>
        <div class="stat-value" id="stat-sessions" style="color:var(--accent2)">0</div>
        <div class="stat-sub">ç­†è¨˜éŒ„</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">æœ€é•·ä¸€æ¬¡</div>
        <div class="stat-value" id="stat-longest" style="color:var(--accent5)">â€”</div>
        <div class="stat-sub">å–®æ¬¡</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">æœ€å¤šæ¨™ç±¤</div>
        <div class="stat-value" id="stat-top-label" style="color:var(--accent3); font-size:14px;">â€”</div>
        <div class="stat-sub">ä½”æœ€å¤šæ™‚é–“</div>
      </div>
    </div>
    <div style="margin-top:20px;">
      <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:12px;">
        <div class="section-title" style="margin-bottom:0;">å„æ¨™ç±¤æ™‚é–“</div>
        <div class="view-toggle">
          <button class="view-btn active" id="btn-bar">â–¬ é•·æ¢</button>
          <button class="view-btn" id="btn-pie">â—‰ åœ“é¤…</button>
        </div>
      </div>
      <div id="label-stats"></div>
    </div>
  </div>
</main>

<footer>
  <span id="total-footer">SESSION: 0</span>
  <span>Firebase é›²ç«¯åŒæ­¥ Â· è·¨è£ç½®</span>
</footer>

<!-- æ‰‹æ©Ÿç‰ˆåº•éƒ¨å°è¦½åˆ— -->
<nav class="mobile-tabs">
  <button class="mobile-tab active" id="tab-timer" onclick="switchTab('timer')">
    <span class="mobile-tab-icon">â±</span>
    <span>è¨ˆæ™‚</span>
  </button>
  <button class="mobile-tab" id="tab-records" onclick="switchTab('records')">
    <span class="mobile-tab-icon">ğŸ“‹</span>
    <span>è¨˜éŒ„</span>
  </button>
  <button class="mobile-tab" id="tab-stats" onclick="switchTab('stats')">
    <span class="mobile-tab-icon">ğŸ“Š</span>
    <span>çµ±è¨ˆ</span>
  </button>
  <button class="mobile-tab" id="tab-labels" onclick="switchTab('labels')">
    <span class="mobile-tab-icon">ğŸ·</span>
    <span>æ¨™ç±¤</span>
  </button>
</nav>


<script>
// â”€â”€ å¯†ç¢¼ä¿è­· â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CORRECT_PASSWORD = '453698'; // â† æ”¹é€™è£¡å¯ä»¥æ›å¯†ç¢¼
let pwInput = '';

function checkPassword() {
  const screen = document.getElementById('password-screen');
  const loading = document.getElementById('loading-overlay'); 
  
  if (sessionStorage.getItem('pw_ok') === '1') {
    if (screen) {
      screen.classList.add('hidden');
      screen.style.display = 'none';
    }
    if (loading) {
      loading.classList.add('hidden'); 
    }
    return;
  }
  
  // è‹¥æ²’é©—è­‰éï¼Œç¢ºä¿å¯†ç¢¼ç•«é¢æ˜¯é¡¯ç¤ºçš„
  if (screen) {
    screen.classList.remove('hidden');
    screen.style.display = 'flex';
  }
}

function updateDots() {
  const dots = document.querySelectorAll('.pw-dot');
  dots.forEach((d, i) => {
    d.classList.toggle('filled', i < pwInput.length);
    d.classList.remove('error');
  });
  document.getElementById('pw-error').textContent = '';
}

function handleKey(key) {
  if (key === 'del') {
    pwInput = pwInput.slice(0, -1);
    updateDots();
    return;
  }
  if (pwInput.length >= CORRECT_PASSWORD.length) return;
  pwInput += key;
  updateDots();

  // é•·åº¦é–¥é–€
  if (pwInput.length === CORRECT_PASSWORD.length) {
    if (pwInput === CORRECT_PASSWORD) {
      sessionStorage.setItem('pw_ok', '1');
      const screen = document.getElementById('password-screen');
      screen.classList.add('hidden');
      screen.style.display = 'none';
      const main = document.querySelector('.main-content');
      if (main) main.style.display = '';
      const loading = document.getElementById('loading-overlay');
      if (loading) loading.classList.add('hidden');
      initMobilePanels();
      switchTab('timer');
    } else {

      document.querySelectorAll('.pw-dot').forEach(d => {
        d.classList.remove('filled');
        d.classList.add('error');
      });

      document.getElementById('pw-error').textContent = 'å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡è©¦';

      setTimeout(() => {
        pwInput = '';
        updateDots();
      }, 800);
    }
  }
}

document.querySelectorAll('.pw-key').forEach(btn => {
  btn.addEventListener('click', () => handleKey(btn.dataset.key));
});

// æ”¯æ´éµç›¤è¼¸å…¥
document.addEventListener('keydown', e => {
  if (document.getElementById('password-screen').classList.contains('hidden')) return;
  if (e.key >= '0' && e.key <= '9') handleKey(e.key);
  if (e.key === 'Backspace') handleKey('del');
});

checkPassword();
</script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getFirestore, collection, doc, getDocs, addDoc, deleteDoc,
  onSnapshot, query, orderBy, writeBatch
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import {
  getAuth, signInAnonymously, onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

// â”€â”€ Firebase è¨­å®š â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const firebaseConfig = {
  apiKey: "AIzaSyD3wAyM8ba24HyT3aIjDspI92zugLsvSrg",
  authDomain: "timer-tracker-1993d.firebaseapp.com",
  projectId: "timer-tracker-1993d",
  storageBucket: "timer-tracker-1993d.firebasestorage.app",
  messagingSenderId: "799601531684",
  appId: "1:799601531684:web:f9fb3c4b769a1b84d7b1b1"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// â”€â”€ ç‹€æ…‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let labels = [];
let sessions = [];
let activeLabelId = null;
let selectedColor = '#c8f040';
let startTime = null;
let timerInterval = null;
let isPaused = false;
let elapsedAtPause = 0;
let currentView = 'bar';

let DEFAULT_COLORS = ['#c8f040','#40f0b4','#f04080','#40a0f0','#f0a040','#b040f0','#f0f040','#40f0f0'];
let COLORS = [...DEFAULT_COLORS];

function renderColorPicker() {
  const list = document.getElementById('color-picker-list');
  const mobList = document.getElementById('mobile-color-picker-list');
  if (!list) return;

  const generateHTML = (isMobile) => {
    return COLORS.map((c, index) => {
      const isCustom = !DEFAULT_COLORS.includes(c); // åˆ¤æ–·æ˜¯å¦ç‚ºè‡ªè¨‚é¡è‰²
      return `
        <div class="swatch-wrapper">
          <div class="color-swatch ${c===selectedColor?'selected':''}" 
               style="background:${c}; ${isMobile?'width:28px;height:28px;':''}" 
               data-color="${c}"></div>
          ${isCustom ? `<button class="btn-del-color" data-index="${index}">Ã—</button>` : ''}
        </div>`;
    }).join('');
  };

  // æ¸²æŸ“æ¡Œé¢ç‰ˆèˆ‡æ‰‹æ©Ÿç‰ˆ
  list.innerHTML = generateHTML(false);
  if (mobList) mobList.innerHTML = generateHTML(true);

  // ç¶å®šé»æ“Šé¸å–äº‹ä»¶
  document.querySelectorAll('.color-swatch').forEach(el => {
    el.addEventListener('click', () => selectColor(el.dataset.color));
  });

  // ç¶å®šåˆªé™¤é¡è‰²äº‹ä»¶
  document.querySelectorAll('.btn-del-color').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation(); // é˜²æ­¢è§¸ç™¼é¸å–é¡è‰²
      const index = btn.dataset.index;
      const deletedColor = COLORS[index];
      
      COLORS.splice(index, 1); // å¾é™£åˆ—ç§»é™¤
      
      // å¦‚æœåˆªæ‰çš„æ˜¯ç›®å‰é¸ä¸­çš„é¡è‰²ï¼Œå°±è·³å›ç¬¬ä¸€å€‹é è¨­è‰²
      if (selectedColor === deletedColor) {
        selectedColor = COLORS[0];
      }
      render(); // é‡æ–°æ¸²æŸ“å…¨åŸŸ
    });
  });
}

// â”€â”€ Sync ç‹€æ…‹ UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setSyncStatus(state) {
  const dot = document.getElementById('sync-dot');
  const lbl = document.getElementById('sync-label');
  dot.className = 'sync-dot ' + state;
  lbl.textContent = { connected: 'å·²åŒæ­¥', syncing: 'åŒæ­¥ä¸­', error: 'é›¢ç·š' }[state] || 'é€£ç·šä¸­';
}

// â”€â”€ è¼”åŠ©å‡½å¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getActiveLabel() { return labels.find(l => l.id === activeLabelId) || null; }

function todaySessions() {
  const today = new Date().toDateString();
  return sessions.filter(s => new Date(s.startTs).toDateString() === today);
}

function formatMs(ms) {
  const s = Math.floor(ms / 1000);
  return `${pad(Math.floor(s/3600))}:${pad(Math.floor((s%3600)/60))}:${pad(s%60)}`;
}

function formatShort(ms) {
  const s = Math.floor(ms / 1000);
  const h = Math.floor(s / 3600);
  const m = Math.floor((s % 3600) / 60);
  if (h > 0) return `${h}h${pad(m)}m`;
  return `${m}m${pad(s % 60)}s`;
}

function pad(n) { return String(n).padStart(2, '0'); }

// â”€â”€ æ¨™ç±¤æ“ä½œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function addLabel() {
  const input = document.getElementById('new-label-input');
  const name = input.value.trim();
  if (!name) return;
  setSyncStatus('syncing');
  await addDoc(collection(db, 'labels'), { id: Date.now(), name, color: selectedColor, createdAt: Date.now() });
  input.value = '';
}

async function deleteLabel(firestoreId) {
  const lbl = labels.find(l => l.firestoreId === firestoreId);
  if (lbl && activeLabelId === lbl.id) resetTimer();
  setSyncStatus('syncing');
  await deleteDoc(doc(db, 'labels', firestoreId));
}

function selectLabel(id) {
  activeLabelId = id;
  updateActiveBadge();
  renderPills();
}

function selectColor(c) {
  selectedColor = c;
  renderColorPicker();
}

// â”€â”€ è¨ˆæ™‚å™¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startTimer() {
  const lbl = getActiveLabel();
  if (!lbl) { alert('è«‹å…ˆé¸æ“‡ä¸€å€‹æ¨™ç±¤ï¼'); return; }
  if (isPaused) {
    startTime = Date.now() - elapsedAtPause;
    isPaused = false;
  } else {
    startTime = Date.now();
    elapsedAtPause = 0;
    document.getElementById('session-date').textContent = new Date().toLocaleString('zh-TW');
  }
  timerInterval = setInterval(() => {
    document.getElementById('time-display').textContent = formatMs(Date.now() - startTime);
  }, 100);
  document.getElementById('start-btn').disabled = true;
  document.getElementById('pause-btn').disabled = false;
  document.getElementById('stop-btn').disabled = false;
  document.getElementById('time-display').classList.add('running');
}

function pauseTimer() {
  if (!timerInterval) return;
  clearInterval(timerInterval);
  timerInterval = null;
  elapsedAtPause = Date.now() - startTime;
  isPaused = true;
  document.getElementById('start-btn').disabled = false;
  document.getElementById('start-btn').textContent = 'â–¶ ç¹¼çºŒ';
  document.getElementById('time-display').classList.remove('running');
}

async function stopTimer() {
  if (!timerInterval && !isPaused) return;
  clearInterval(timerInterval);
  const elapsed = isPaused ? elapsedAtPause : Date.now() - startTime;
  const lbl = getActiveLabel();
  if (elapsed > 1000 && lbl) {
    setSyncStatus('syncing');
    await addDoc(collection(db, 'sessions'), {
      labelId: lbl.id,
      labelName: lbl.name,
      labelColor: lbl.color,
      duration: elapsed,
      startTs: startTime || Date.now() - elapsed,
      endTs: Date.now()
    });
  }
  resetTimer();
}

function resetTimer() {
  clearInterval(timerInterval);
  timerInterval = null; isPaused = false; elapsedAtPause = 0;
  document.getElementById('time-display').textContent = '00:00:00';
  document.getElementById('time-display').classList.remove('running');
  document.getElementById('session-date').textContent = 'â€”';
  document.getElementById('start-btn').disabled = false;
  document.getElementById('start-btn').textContent = 'â–¶ é–‹å§‹';
  document.getElementById('pause-btn').disabled = true;
  document.getElementById('stop-btn').disabled = true;
}

async function deleteSession(firestoreId) {
  setSyncStatus('syncing');
  await deleteDoc(doc(db, 'sessions', firestoreId));
}

async function clearAll() {
  if (!confirm('ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰ä»Šæ—¥è¨˜éŒ„å—ï¼Ÿ')) return;
  setSyncStatus('syncing');
  const batch = writeBatch(db);
  todaySessions().forEach(s => batch.delete(doc(db, 'sessions', s.firestoreId)));
  await batch.commit();
}

function setView(v) {
  currentView = v;
  document.getElementById('btn-bar').classList.toggle('active', v === 'bar');
  document.getElementById('btn-pie').classList.toggle('active', v === 'pie');
  renderStats();
}

// â”€â”€ æœŸé–“ç¯©é¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentPeriod = 'day'; // 'day' | 'week' | 'month'

function setPeriod(p) {
  currentPeriod = p;
  ['day','week','month'].forEach(x => {
    document.getElementById('period-' + x).classList.toggle('active', x === p);
  });
  renderStats();
}

function periodSessions() {
  const now = new Date();
  if (currentPeriod === 'day') {
    const today = now.toDateString();
    return sessions.filter(s => new Date(s.startTs).toDateString() === today);
  }
  if (currentPeriod === 'week') {
    // Monday-based week
    const day = now.getDay(); // 0=Sun
    const diffToMon = (day === 0 ? -6 : 1 - day);
    const mon = new Date(now);
    mon.setHours(0, 0, 0, 0);
    mon.setDate(now.getDate() + diffToMon);
    return sessions.filter(s => s.startTs >= mon.getTime());
  }
  if (currentPeriod === 'month') {
    const start = new Date(now.getFullYear(), now.getMonth(), 1).getTime();
    return sessions.filter(s => s.startTs >= start);
  }
  return [];
}

function periodRangeLabel() {
  const now = new Date();
  const fmt = d => d.toLocaleDateString('zh-TW', { month: 'numeric', day: 'numeric' });
  if (currentPeriod === 'day') return now.toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric' });
  if (currentPeriod === 'week') {
    const day = now.getDay();
    const diffToMon = (day === 0 ? -6 : 1 - day);
    const mon = new Date(now); mon.setHours(0,0,0,0); mon.setDate(now.getDate() + diffToMon);
    const sun = new Date(mon); sun.setDate(mon.getDate() + 6);
    return `${fmt(mon)} â€” ${fmt(sun)}`;
  }
  if (currentPeriod === 'month') {
    return now.toLocaleDateString('zh-TW', { year: 'numeric', month: 'long' });
  }
  return '';
}

// â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render() {
  renderPills();
  renderLabelsManager();
  renderSessions();
  renderStats();
  renderColorPicker();
  updateActiveBadge();
  // æ‰‹æ©Ÿç‰ˆè£œå……æ›´æ–°
  if (currentTab === 'records') renderMobileRecords();
  if (currentTab === 'labels') renderMobileLabels();
}

function updateActiveBadge() {
  const badge = document.getElementById('active-badge');
  const lbl = getActiveLabel();
  if (lbl) {
    badge.textContent = lbl.name;
    badge.style.background = lbl.color + '22';
    badge.style.color = lbl.color;
    badge.style.borderLeft = `3px solid ${lbl.color}`;
  } else {
    badge.textContent = 'å°šæœªé¸æ“‡';
    badge.style.background = '#1e1e1e';
    badge.style.color = '#666';
    badge.style.borderLeft = '';
  }
}



// è™•ç†è‡ªè¨‚é¡è‰²é¸å–äº‹ä»¶

// æ¡Œé¢ç‰ˆè‡ªè¨‚é¡è‰²ç›£è½
// çµ±ä¸€è™•ç†é¡è‰²é¸å–ï¼ˆåŒæ™‚ç›£è½ input å’Œ changeï¼Œç›¸å®¹ iOS Safariï¼‰
function handleColorInput(e) {
  const newColor = e.target.value;
  if (!COLORS.includes(newColor)) {
    COLORS.push(newColor);
  }
  selectColor(newColor);
  render();
}

const hiddenInput = document.getElementById('hidden-color-input');
if (hiddenInput) {
  hiddenInput.addEventListener('input', handleColorInput);
  hiddenInput.addEventListener('change', handleColorInput);
}

const mobHiddenInput = document.getElementById('mobile-hidden-color-input');
if (mobHiddenInput) {
  mobHiddenInput.addEventListener('input', handleColorInput);
  mobHiddenInput.addEventListener('change', handleColorInput);
}

function renderPills() {
  const container = document.getElementById('label-pills');
  if (!labels.length) {
    container.innerHTML = '<span style="font-size:12px;color:var(--muted)">å°šæœªå»ºç«‹æ¨™ç±¤</span>';
    return;
  }
  container.innerHTML = labels.map(l =>
    `<div class="label-pill ${activeLabelId===l.id?'active':''}"
      style="color:${l.color}; background:${l.color}11; ${activeLabelId===l.id?'border-color:'+l.color:''}"
      data-id="${l.id}">${l.name}</div>`
  ).join('');
  container.querySelectorAll('.label-pill').forEach(el => {
    el.addEventListener('click', () => selectLabel(Number(el.dataset.id)));
  });
}

function renderLabelsManager() {
  const c = document.getElementById('labels-manager');
  if (!labels.length) { c.innerHTML = ''; return; }
  c.innerHTML = labels.map(l =>
    `<div style="display:flex; align-items:center; gap:8px; padding:6px 0; border-bottom:1px solid var(--border);">
      <div style="width:10px;height:10px;border-radius:50%;background:${l.color};flex-shrink:0;"></div>
      <span style="flex:1;font-size:13px;">${l.name}</span>
      <button class="del-label-btn" data-fid="${l.firestoreId}"
        style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:14px;">Ã—</button>
    </div>`
  ).join('');
  c.querySelectorAll('.del-label-btn').forEach(btn => {
    btn.addEventListener('click', () => deleteLabel(btn.dataset.fid));
  });
}

function renderSessions() {
  const list = document.getElementById('sessions-list');
  const today = todaySessions();
  if (!today.length) {
    list.innerHTML = '<div class="empty-state"><div class="empty-icon">â±</div><div class="empty-text">å°šç„¡è¨˜éŒ„<br>é¸æ“‡æ¨™ç±¤å¾Œé–‹å§‹è¨ˆæ™‚</div></div>';
    document.getElementById('total-footer').textContent = 'SESSION: 0';
    return;
  }
  list.innerHTML = today.map(s =>
    `<div class="session-item">
      <div class="session-dot" style="background:${s.labelColor}"></div>
      <div class="session-info">
        <div class="session-label-name" style="color:${s.labelColor}">${s.labelName}</div>
        <div class="session-meta">${new Date(s.startTs).toLocaleTimeString('zh-TW',{hour:'2-digit',minute:'2-digit'})}</div>
      </div>
      <div class="session-duration">${formatShort(s.duration)}</div>
      <button class="delete-session del-sess-btn" data-fid="${s.firestoreId}">Ã—</button>
    </div>`
  ).join('');
  list.querySelectorAll('.del-sess-btn').forEach(btn => {
    btn.addEventListener('click', () => deleteSession(btn.dataset.fid));
  });
  document.getElementById('total-footer').textContent = `SESSION: ${today.length}`;
}

function renderStats() {
  const periodData = periodSessions();
  const total = periodData.reduce((a, s) => a + s.duration, 0);

  // Update range label
  document.getElementById('period-range-label').textContent = periodRangeLabel();

  document.getElementById('stat-total').textContent = formatShort(total);
  document.getElementById('stat-sessions').textContent = periodData.length;
  document.getElementById('stat-longest').textContent = periodData.length
    ? formatShort(Math.max(...periodData.map(s => s.duration))) : 'â€”';

  const byLabel = {};
  periodData.forEach(s => {
    if (!byLabel[s.labelId]) byLabel[s.labelId] = { name: s.labelName, color: s.labelColor, total: 0 };
    byLabel[s.labelId].total += s.duration;
  });

  const sorted = Object.values(byLabel).sort((a, b) => b.total - a.total);
  document.getElementById('stat-top-label').textContent = sorted.length ? sorted[0].name : 'â€”';

  const statsEl = document.getElementById('label-stats');
  if (!sorted.length) {
    statsEl.innerHTML = '<div style="font-size:12px;color:var(--muted);">é‚„æ²’æœ‰è¨˜éŒ„</div>';
    return;
  }

  if (currentView === 'pie') { statsEl.innerHTML = renderPieChart(sorted, total); return; }

  statsEl.innerHTML = '<div class="label-stats">' + sorted.map(l => {
    const pct = total ? (l.total / total * 100) : 0;
    return `<div class="label-stat-row">
      <div class="label-stat-name" style="color:${l.color}">${l.name}</div>
      <div class="label-stat-bar-wrap"><div class="label-stat-bar" style="width:${pct}%;background:${l.color}"></div></div>
      <div class="label-stat-time">${formatShort(l.total)}</div>
    </div>`;
  }).join('') + '</div>';
}

function renderPieChart(sorted, total) {
  const cx = 80, cy = 80, r = 68, innerR = 40;
  let angle = -Math.PI / 2;
  const slices = sorted.map(l => {
    const frac = total ? l.total / total : 0;
    const sweep = frac * 2 * Math.PI;
    const start = angle; angle += sweep;
    return { ...l, frac, start, end: angle, sweep };
  });

  const polar = (a, rad) => [cx + rad * Math.cos(a), cy + rad * Math.sin(a)];

  const paths = slices.map((s, i) => {
    let d;
    if (s.sweep >= 2 * Math.PI - 0.001) {
      d = `M ${cx} ${cy-r} A ${r} ${r} 0 1 1 ${cx-0.01} ${cy-r} Z`;
    } else {
      const [x1,y1]=polar(s.start,r), [x2,y2]=polar(s.end,r);
      const [ix1,iy1]=polar(s.end,innerR), [ix2,iy2]=polar(s.start,innerR);
      const lg = s.sweep > Math.PI ? 1 : 0;
      d = `M ${x1} ${y1} A ${r} ${r} 0 ${lg} 1 ${x2} ${y2} L ${ix1} ${iy1} A ${innerR} ${innerR} 0 ${lg} 0 ${ix2} ${iy2} Z`;
    }
    const [tx,ty] = polar((s.start+s.end)/2, (r+innerR)/2);
    return `<path d="${d}" fill="${s.color}" opacity="0.9" style="transition:opacity 0.2s;"
      onmouseover="this.style.opacity=1;document.getElementById('ph${i}').style.opacity=1;"
      onmouseout="this.style.opacity=0.9;document.getElementById('ph${i}').style.opacity=0;">
      <title>${s.name}: ${formatShort(s.total)} (${(s.frac*100).toFixed(1)}%)</title>
    </path>
    <text id="ph${i}" x="${tx}" y="${ty}" text-anchor="middle" dominant-baseline="middle"
      font-family="Space Mono,monospace" font-size="9" fill="#000" opacity="0"
      style="pointer-events:none;transition:opacity 0.2s;">${(s.frac*100).toFixed(0)}%</text>`;
  }).join('');

  return `<div class="pie-wrap">
    <div class="pie-canvas-wrap">
      <svg width="160" height="160" viewBox="0 0 160 160">
        ${paths}
        <circle cx="${cx}" cy="${cy}" r="${innerR}" fill="var(--bg)" />
      </svg>
      <div class="pie-center-text">
        <div class="pie-center-value">${sorted.length}</div>
        <div class="pie-center-label">æ¨™ç±¤</div>
      </div>
    </div>
    <div class="pie-legend">${slices.map(s => `
      <div class="pie-legend-item">
        <div class="pie-legend-dot" style="background:${s.color}"></div>
        <div class="pie-legend-name" style="color:${s.color}">${s.name}</div>
        <div class="pie-legend-pct">${formatShort(s.total)}</div>
      </div>`).join('')}
    </div>
  </div>`;
}

// â”€â”€ æ‰‹æ©Ÿç‰ˆ Tab åˆ‡æ› â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentTab = 'timer';

function switchTab(tab) {
  currentTab = tab;

  // æ›´æ–° tab æŒ‰éˆ•æ¨£å¼
  ['timer','records','stats','labels'].forEach(t => {
    const btn = document.getElementById('tab-' + t);
    if (btn) btn.classList.toggle('active', t === tab);
  });

  const isMobile = window.innerWidth <= 700;
  if (!isMobile) return;

  // æ§åˆ¶å„å€å¡Šé¡¯ç¤º
  const timerDisplay = document.querySelector('.timer-display');
  const statsSection = document.querySelector('.stats-section');
  const mobileRecords = document.getElementById('mobile-records-panel');
  const mobileLabels = document.getElementById('mobile-labels-panel');

  [timerDisplay, statsSection, mobileRecords, mobileLabels].forEach(el => {
    if (el) el.style.display = 'none';
  });

  if (tab === 'timer' && timerDisplay) timerDisplay.style.display = 'flex';
  if (tab === 'stats' && statsSection) statsSection.style.display = 'block';
  if (tab === 'records' && mobileRecords) { mobileRecords.style.display = 'block'; renderMobileRecords(); }
  if (tab === 'labels' && mobileLabels) { mobileLabels.style.display = 'block'; renderMobileLabels(); }
}

function initMobilePanels() {
  if (window.innerWidth > 700) return;

  // å»ºç«‹æ‰‹æ©Ÿç‰ˆè¨˜éŒ„é¢æ¿
  if (!document.getElementById('mobile-records-panel')) {
    const recPanel = document.createElement('div');
    recPanel.id = 'mobile-records-panel';
    recPanel.style.cssText = 'display:none; padding:16px;';
    recPanel.innerHTML = `
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
        <div class="section-title" style="margin-bottom:0;">è¨ˆæ™‚è¨˜éŒ„</div>
        <button class="btn btn-sm btn-danger" id="mobile-clear-btn" style="padding:3px 8px; font-size:10px;">å…¨æ¸…</button>
      </div>
      <div id="mobile-sessions-list" style="display:flex; flex-direction:column; gap:6px;"></div>
    `;
    document.querySelector('.main-content').appendChild(recPanel);
    document.getElementById('mobile-clear-btn').addEventListener('click', clearAll);
  }

  // å»ºç«‹æ‰‹æ©Ÿç‰ˆæ¨™ç±¤é¢æ¿
  if (!document.getElementById('mobile-labels-panel')) {
    const lblPanel = document.createElement('div');
    lblPanel.id = 'mobile-labels-panel';
    lblPanel.style.cssText = 'display:none; padding:16px;';
    lblPanel.innerHTML = `
      <div class="section-title" style="margin-bottom:12px;">æ¨™ç±¤ç®¡ç†</div>
      <div id="mobile-labels-manager" style="display:flex; flex-direction:column; gap:8px; margin-bottom:16px;"></div>
      <div class="add-label-form">
        <input type="text" id="mobile-label-input" placeholder="æ–°å¢æ¨™ç±¤åç¨±..." maxlength="20">
        <button class="btn btn-sm" id="mobile-add-label-btn">ï¼‹</button>
      </div>
      
      <div class="color-picker" style="margin-top:8px;">
        <div id="mobile-color-picker-list" style="display:flex; flex-wrap:wrap; gap:6px;"></div>
        <label for="mobile-hidden-color-input" class="btn-add-color" style="cursor:pointer; display:inline-flex; align-items:center; justify-content:center;">+</label>
        <input type="color" id="mobile-hidden-color-input" style="opacity:0; position:absolute; width:1px; height:1px;">
      </div>
    `;
    document.querySelector('.main-content').appendChild(lblPanel);
    document.getElementById('mobile-add-label-btn').addEventListener('click', () => {
      const input = document.getElementById('mobile-label-input');
      const name = input.value.trim();
      if (!name) return;
      setSyncStatus('syncing');
      addDoc(collection(db, 'labels'), { id: Date.now(), name, color: selectedColor, createdAt: Date.now() });
      input.value = '';
    });
    document.getElementById('mobile-label-input').addEventListener('keydown', e => {
      if (e.key === 'Enter') document.getElementById('mobile-add-label-btn').click();
    });
    
  }

  // é è¨­åªé¡¯ç¤ºè¨ˆæ™‚é¢æ¿
  // --- é—œéµä¿®æ”¹åœ¨æ­¤ï¼šå°‡åŸæœ¬ç›´æ¥åŸ·è¡Œçš„ switchTab('timer') åŒ…è£¹åœ¨ if åˆ¤æ–·ä¸­ ---
  if (sessionStorage.getItem('pw_ok') === '1') {
    switchTab('timer');
  } else {
    // å¦‚æœå¯†ç¢¼é‚„æ²’éï¼Œå…ˆæŠŠä¸»å…§å®¹éš±è—ï¼Œé¿å…æ“‹ä½å¯†ç¢¼ç•«é¢æˆ–é€ æˆä½ˆå±€æ··äº‚
    const mainContent = document.querySelector('.main-content');
    if (mainContent) mainContent.style.display = 'none';
  }
}

function renderMobileRecords() {
  const list = document.getElementById('mobile-sessions-list');
  if (!list) return;
  const today = todaySessions();
  if (!today.length) {
    list.innerHTML = '<div class="empty-state"><div class="empty-icon">â±</div><div class="empty-text">å°šç„¡è¨˜éŒ„<br>é¸æ“‡æ¨™ç±¤å¾Œé–‹å§‹è¨ˆæ™‚</div></div>';
    return;
  }
  list.innerHTML = today.map(s =>
    `<div class="session-item">
      <div class="session-dot" style="background:${s.labelColor}"></div>
      <div class="session-info">
        <div class="session-label-name" style="color:${s.labelColor}">${s.labelName}</div>
        <div class="session-meta">${new Date(s.startTs).toLocaleTimeString('zh-TW',{hour:'2-digit',minute:'2-digit'})}</div>
      </div>
      <div class="session-duration">${formatShort(s.duration)}</div>
      <button class="delete-session" data-fid="${s.firestoreId}">Ã—</button>
    </div>`
  ).join('');
  list.querySelectorAll('.delete-session').forEach(btn => {
    btn.addEventListener('click', () => deleteSession(btn.dataset.fid));
  });
}

function renderMobileLabels() {
  const mgr = document.getElementById('mobile-labels-manager');
  const cpList = document.getElementById('mobile-color-picker-list'); // ä¿®æ­£ ID
  if (!mgr || !cpList) return;

  // æ¸²æŸ“æ‰‹æ©Ÿç‰ˆæ¨™ç±¤æ¸…å–®
  mgr.innerHTML = labels.map(l =>
    `<div style="display:flex; align-items:center; gap:8px; padding:8px 0; border-bottom:1px solid var(--border);">
      <div style="width:12px;height:12px;border-radius:50%;background:${l.color};flex-shrink:0;"></div>
      <span style="flex:1;font-size:14px;">${l.name}</span>
      <button class="del-label-btn" data-fid="${l.firestoreId}"
        style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:18px;padding:0 4px;">Ã—</button>
    </div>`
  ).join('');

  mgr.querySelectorAll('.del-label-btn').forEach(btn => {
    btn.addEventListener('click', () => deleteLabel(btn.dataset.fid));
  });

  // æ¸²æŸ“æ‰‹æ©Ÿç‰ˆé¡è‰²é¸å–å€ï¼ˆåŒ…å«åˆªé™¤è‡ªè¨‚é¡è‰²åŠŸèƒ½ï¼‰
  const DEFAULT_LIST = ['#c8f040','#40f0b4','#f04080','#40a0f0','#f0a040','#b040f0','#f0f040','#40f0f0'];
  
  cpList.innerHTML = COLORS.map((c, index) => {
    const isCustom = !DEFAULT_LIST.includes(c);
    return `
      <div class="swatch-wrapper">
        <div class="color-swatch ${c===selectedColor?'selected':''}" 
             style="background:${c}; width:28px; height:28px;" 
             data-color="${c}"></div>
        ${isCustom ? `<button class="btn-del-color" data-index="${index}">Ã—</button>` : ''}
      </div>`;
  }).join('');

  // ç¶å®šé¸å–èˆ‡åˆªé™¤äº‹ä»¶
  cpList.querySelectorAll('.color-swatch').forEach(el => {
    el.addEventListener('click', () => { 
      selectColor(el.dataset.color); 
      render(); 
    });
  });

  cpList.querySelectorAll('.btn-del-color').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const idx = btn.dataset.index;
      const deletedColor = COLORS[idx];
      COLORS.splice(idx, 1);
      if (selectedColor === deletedColor) selectedColor = COLORS[0];
      render();
    });
  });
}

setInterval(() => {
  document.getElementById('live-clock').textContent = new Date().toLocaleString('zh-TW');
}, 1000);
document.getElementById('live-clock').textContent = new Date().toLocaleString('zh-TW');


// â”€â”€ äº‹ä»¶ç¶å®š â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('add-label-btn').addEventListener('click', addLabel);
document.getElementById('new-label-input').addEventListener('keydown', e => { if (e.key === 'Enter') addLabel(); });
document.getElementById('clear-all-btn').addEventListener('click', clearAll);
document.getElementById('start-btn').addEventListener('click', startTimer);
document.getElementById('pause-btn').addEventListener('click', pauseTimer);
document.getElementById('stop-btn').addEventListener('click', stopTimer);
document.getElementById('btn-bar').addEventListener('click', () => setView('bar'));
document.getElementById('btn-pie').addEventListener('click', () => setView('pie'));
document.getElementById('period-day').addEventListener('click', () => setPeriod('day'));
document.getElementById('period-week').addEventListener('click', () => setPeriod('week'));
document.getElementById('period-month').addEventListener('click', () => setPeriod('month'));

// â”€â”€ åˆå§‹åŒ–é è¨­æ¨™ç±¤ï¼ˆç¬¬ä¸€æ¬¡ä½¿ç”¨ï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function initDefaultLabels() {
  const snap = await getDocs(collection(db, 'labels'));
  if (snap.empty) {
    for (const l of [
      { id: 1, name: 'å·¥ä½œ', color: COLORS[0] },
      { id: 2, name: 'å­¸ç¿’', color: COLORS[1] },
      { id: 3, name: 'ä¼‘æ¯', color: COLORS[2] },
    ]) await addDoc(collection(db, 'labels'), { ...l, createdAt: Date.now() });
  }
}

// â”€â”€ å³æ™‚ç›£è½ Firestore â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startRealtimeSync() {
  onSnapshot(collection(db, 'labels'), snap => {
    labels = snap.docs.map(d => ({ firestoreId: d.id, ...d.data() }));
    setSyncStatus('connected');
    render();
  }, () => setSyncStatus('error'));

  onSnapshot(
    query(collection(db, 'sessions'), orderBy('startTs', 'desc')),
    snap => {
      sessions = snap.docs.map(d => ({ firestoreId: d.id, ...d.data() }));
      setSyncStatus('connected');
      render();
    },
    () => setSyncStatus('error')
  );

  setTimeout(() => {
      // åªæœ‰åœ¨å¯†ç¢¼é©—è­‰æˆåŠŸéçš„æƒ…æ³ä¸‹ï¼Œæ‰è‡ªå‹•éš±è— Loading é®ç½©
      if (sessionStorage.getItem('pw_ok') === '1') {
        const loading = document.getElementById('loading-overlay');
        if (loading) loading.classList.add('hidden');
      }
      initMobilePanels();
    }, 500);
  }

window.switchTab = switchTab;
document.getElementById('loading-text').textContent = 'ç™»å…¥ä¸­...';

onAuthStateChanged(auth, async (user) => {
  const loading = document.getElementById('loading-overlay');
  const loadingText = document.getElementById('loading-text');

  if (user) {
    try {
      if (loadingText) loadingText.textContent = 'è¼‰å…¥è³‡æ–™ä¸­...';
      await initDefaultLabels();
      startRealtimeSync();
      
      // é—œéµï¼šå¦‚æœå¯†ç¢¼å·²ç¶“é©—è­‰éï¼Œç«‹å³è§£é™¤é®ç½©
      if (sessionStorage.getItem('pw_ok') === '1') {
        if (loading) loading.classList.add('hidden');
        const main = document.querySelector('.main-content');
        if (main) main.style.display = ''; 
      }
    } catch (e) {
      console.error("è³‡æ–™åˆå§‹åŒ–å¤±æ•—:", e);
      if (loadingText) loadingText.textContent = 'é€£ç·šç•°å¸¸ï¼Œè«‹é‡æ–°æ•´ç†';
    }
  } else {
    signInAnonymously(auth).catch(e => console.error("åŒ¿åç™»å…¥å¤±æ•—:", e));
  }
});

try {
  await signInAnonymously(auth);
} catch (e) {
  document.getElementById('loading-text').textContent = 'ç™»å…¥å¤±æ•—ï¼Œè«‹ç¢ºèªç¶²è·¯';
  setSyncStatus('error');
  console.error(e);
}
checkPassword();
</script>
</body>
</html>
